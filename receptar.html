<!DOCTYPE html>
<html lang="cs">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>≈†PAJZ | Recept√°≈ô</title>
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Cherry+Bomb+One&family=Jost:wght@300;400;500;600;700&display=swap"
			rel="stylesheet"
		/>
		<link rel="stylesheet" href="styles.css" />
	</head>
	<body class="app-body">
		<div class="app-menu-backdrop" id="menu-backdrop-receptar">
			<nav class="app-menu-panel" aria-label="Hlavn√≠ navigace">
				<h2 class="app-menu-title">Menu</h2>
				<ul class="app-menu-list">
					<li><a href="chutomer.html" class="app-menu-link">Chu≈•omƒõr</a></li>
					<li>
						<a href="receptar.html" class="app-menu-link app-menu-link-active"
								>Recept√°≈ô</a
						>
					</li>
					<li><a href="profil.html" class="app-menu-link">Profil</a></li>
				</ul>
			</nav>
		</div>

		<main class="taste-page">
			<header class="taste-header">
				<button
					class="app-menu-toggle"
					type="button"
					aria-label="Otev≈ô√≠t menu"
					aria-controls="menu-backdrop-receptar"
				>
					<div class="app-menu-icon" aria-hidden="true">
						<span></span>
						<span></span>
						<span></span>
					</div>
				</button>
				<h1 class="taste-title">RECEPT√Å≈ò</h1>
			</header>

			<section class="recipe-shelf">
				<a href="#" class="recipe-shelf-card" data-meal="FULL MEAL">
					<div class="recipe-shelf-icon" aria-hidden="true">üç≤</div>
					<div class="recipe-shelf-text">Full Meals</div>
				</a>

				<a href="#" class="recipe-shelf-card" data-meal="SN√çDANƒö">
					<div class="recipe-shelf-icon" aria-hidden="true">üç≥</div>
					<div class="recipe-shelf-text">Sn√≠danƒõ</div>
				</a>

				<a href="#" class="recipe-shelf-card" data-meal="SNACK">
					<div class="recipe-shelf-icon" aria-hidden="true">üçø</div>
					<div class="recipe-shelf-text">Snacks</div>
				</a>

				<a href="#" class="recipe-shelf-card" data-meal="DEZERT">
					<div class="recipe-shelf-icon" aria-hidden="true">üßÅ</div>
					<div class="recipe-shelf-text">Dezerty</div>
				</a>
			</section>

			<section class="taste-section" id="shelf-results-section">
				<p class="taste-label" id="shelf-results-heading">
					Vyber kategorii naho≈ôe pro zobrazen√≠ recept≈Ø.
				</p>
				<div id="shelf-results"></div>
			</section>

			<a
				class="recipe-add-button"
				href="novy-recept.html"
				aria-label="P≈ôidat recept"
			>
				+
			</a>
		</main>

		<script type="module">
			import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
			import { SUPABASE_URL, SUPABASE_ANON_KEY } from "./supabase-config.js";

			const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
			const {
				data: { session },
			} = await supabase.auth.getSession();
			if (!session) {
				window.location.href = "index.html";
			}

			const backdrop = document.getElementById("menu-backdrop-receptar");
			const toggle = document.querySelector(".app-menu-toggle");
			const closeMenu = () => backdrop.classList.remove("is-open");
			toggle.addEventListener("click", () => {
				backdrop.classList.toggle("is-open");
			});
			backdrop.addEventListener("click", (e) => {
				if (e.target === backdrop) closeMenu();
			});

			// Recepty podle typu
			const resultsContainer = document.getElementById("shelf-results");
			const headingEl = document.getElementById("shelf-results-heading");
			const shelfCards = document.querySelectorAll(".recipe-shelf-card");
			const timeLabels = ["<15 min", "15‚Äì30 min", "30‚Äì60 min", ">1 h"];
			let allRecipes = [];

			function renderShelfRecipes(type, recipes) {
				resultsContainer.innerHTML = "";

				if (!recipes || !recipes.length) {
					headingEl.textContent = `≈Ω√°dn√© recepty pro kategorii ${type}.`;
					return;
				}

				headingEl.textContent = `Recepty: ${type}`;

				recipes.forEach((recipe) => {
					const article = document.createElement("article");
					article.className = "recipe-card";

					let imageEl;
					if (recipe.photo_url) {
						imageEl = document.createElement("img");
						imageEl.className = "recipe-card-photo";
						imageEl.src = recipe.photo_url;
						imageEl.alt = recipe.name || "Foto receptu";
					} else {
						imageEl = document.createElement("div");
						imageEl.className = "recipe-image-placeholder";
						imageEl.setAttribute("aria-hidden", "true");
					}

					const info = document.createElement("div");
					info.className = "recipe-info";

					const title = document.createElement("h2");
					title.className = "recipe-title";
					title.textContent = recipe.name || "Bez n√°zvu";

					const metaRow = document.createElement("div");
					metaRow.className = "recipe-meta-row";

					if (recipe.prep_time_bucket !== null && recipe.prep_time_bucket !== undefined) {
						const span = document.createElement("span");
						span.className = "recipe-tag";
						const idx = Number(recipe.prep_time_bucket);
						span.textContent = timeLabels[idx] ?? "";
						metaRow.appendChild(span);
					}

					if (Array.isArray(recipe.vibes) && recipe.vibes.length) {
						const span = document.createElement("span");
						span.className = "recipe-tag";
						span.textContent = recipe.vibes[0];
						metaRow.appendChild(span);
					}

					info.appendChild(title);
					info.appendChild(metaRow);

					article.appendChild(imageEl);
					article.appendChild(info);

					if (recipe.id) {
						article.addEventListener("click", () => {
							window.location.href = `recept.html?id=${encodeURIComponent(
								recipe.id
							)}&from=receptar`;
						});
					}

					resultsContainer.appendChild(article);
				});
			}

			async function loadAllRecipes() {
				if (allRecipes.length) return allRecipes;
				try {
					const { data, error } = await supabase
						.from("recipes")
						.select("*")
						.order("created_at", { ascending: false });

					if (error) {
						console.error("Chyba p≈ôi naƒç√≠t√°n√≠ recept≈Ø", error);
						alert("Nepoda≈ôilo se naƒç√≠st recepty.");
						return [];
					}

					const withUrls = await Promise.all(
						(data ?? []).map(async (recipe) => {
							if (recipe.photo_path) {
								try {
									const { data: signed, error: signedError } =
										await supabase.storage
											.from("recipe-photos")
											.createSignedUrl(recipe.photo_path, 60 * 60);
									if (!signedError && signed?.signedUrl) {
										recipe.photo_url = signed.signedUrl;
									}
								} catch (e) {
									console.warn("Nepoda≈ôilo se vytvo≈ôit URL fotky", e);
								}
							}
							return recipe;
						})
					);

					allRecipes = withUrls;
					return allRecipes;
				} catch (err) {
					console.error("Neoƒçek√°van√° chyba p≈ôi naƒç√≠t√°n√≠ recept≈Ø", err);
					alert("Do≈°lo k neoƒçek√°van√© chybƒõ p≈ôi naƒç√≠t√°n√≠ recept≈Ø.");
					return [];
				}
			}

			shelfCards.forEach((card) => {
				card.addEventListener("click", async (e) => {
					e.preventDefault();
					const type = card.getAttribute("data-meal");
					if (!type) return;

					shelfCards.forEach((c) => c.classList.remove("app-menu-link-active"));
					card.classList.add("app-menu-link-active");

					const recipes = await loadAllRecipes();
					const filtered = recipes.filter(
						(r) => r.meal_type && r.meal_type.trim().toUpperCase() === type
					);
					renderShelfRecipes(type, filtered);
				});
			});
		</script>
	</body>
</html>
