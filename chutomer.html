<!DOCTYPE html>
<html lang="cs">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Å PAJZ | ChuÅ¥omÄ›r</title>
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Cherry+Bomb+One&family=Jost:wght@300;400;500;600;700&display=swap"
			rel="stylesheet"
		/>
		<link rel="stylesheet" href="styles.css" />
	</head>
	<body class="app-body">
		<div class="app-menu-backdrop" id="menu-backdrop-chutomer">
			<nav class="app-menu-panel" aria-label="HlavnÃ­ navigace">
				<h2 class="app-menu-title">Menu</h2>
				<ul class="app-menu-list">
					<li>
						<a href="chutomer.html" class="app-menu-link app-menu-link-active"
								>ChuÅ¥omÄ›r</a
						>
					</li>
					<li><a href="receptar.html" class="app-menu-link">ReceptÃ¡Å™</a></li>
					<li><a href="profil.html" class="app-menu-link">Profil</a></li>
				</ul>
			</nav>
		</div>

		<main class="taste-page">
			<header class="taste-header">
				<button
					class="app-menu-toggle"
					type="button"
					aria-label="OtevÅ™Ã­t menu"
					aria-controls="menu-backdrop-chutomer"
				>
					<div class="app-menu-icon" aria-hidden="true">
						<span></span>
						<span></span>
						<span></span>
					</div>
				</button>
				<h1 class="taste-title">CHUÅ¤OMÄšR</h1>
			</header>

			<section class="taste-section">
				<p class="taste-label">MÃ¡m chuÅ¥ na:</p>
				<div class="taste-meal-grid" role="group" aria-label="Typ jÃ­dla">
					<button class="meal-chip meal-chip-active" type="button">
						<span class="meal-icon" aria-hidden="true">ğŸ½ï¸</span>
						<span class="meal-label-main">FULL MEAL</span>
					</button>
					<button class="meal-chip" type="button">
						<span class="meal-icon" aria-hidden="true">ğŸŒ…</span>
						<span class="meal-label-main">SNÃDANÄš</span>
					</button>
					<button class="meal-chip" type="button">
						<span class="meal-icon" aria-hidden="true">ğŸ¥¨</span>
						<span class="meal-label-main">SNACK</span>
					</button>
					<button class="meal-chip" type="button">
						<span class="meal-icon" aria-hidden="true">ğŸ§</span>
						<span class="meal-label-main">DEZERT</span>
					</button>
				</div>
			</section>

			<section class="taste-section">
				<div class="time-scale">
					<span>&lt;15&nbsp;min</span>
					<span>15â€“30&nbsp;min</span>
					<span>30â€“60&nbsp;min</span>
					<span>&gt;1&nbsp;h</span>
				</div>
				<input
					class="time-slider"
					type="range"
					min="0"
					max="3"
					step="1"
					value="1"
					aria-label="Doba pÅ™Ã­pravy"
				/>
			</section>

			<section class="taste-section">
				<div class="pill-row" aria-label="StravovacÃ­ preference">
					<button type="button" class="pill pill-on">VEGET</button>
					<button type="button" class="pill">VEGAN</button>
					<button type="button" class="pill">BEZLEPEK</button>
					<button type="button" class="pill">BEZLAKTO</button>
				</div>
			</section>

			<section class="taste-section">
				<div class="pill-row pill-row-multi" aria-label="Typ chuti">
					<button type="button" class="pill-icon pill-on">sladkÃ©</button>
					<button type="button" class="pill-icon">slanÃ©</button>
					<button type="button" class="pill-icon">pÃ¡livÃ©</button>
					<button type="button" class="pill-icon">fresh</button>
					<button type="button" class="pill-icon">smaÅ¾enÃ©</button>
					<button type="button" class="pill-icon">s masem</button>
				</div>
			</section>

			<section class="taste-section">
				<label class="taste-label" for="ingredient">PotÅ™ebuji spotÅ™ebovat:</label>
				<div class="search-wrapper">
					<span class="search-icon" aria-hidden="true">ğŸ”</span>
					<input
						id="ingredient"
						class="search-input"
						type="search"
						placeholder="Zadej suroviny..."
					/>
				</div>
			</section>

			<section class="taste-section taste-actions">
				<button type="button" class="btn-secondary">PÅ™ekvap mÄ›</button>
				<button type="button" class="btn-primary-wide">HLEDEJ RECEPT</button>
			</section>

			<section class="taste-section">
				<p class="no-recipes-hint">
					ZatÃ­m nemÃ¡te Å¾Ã¡dnÃ© recepty. PÅ™idejte nÄ›jakÃ½ v receptÃ¡Å™i.
				</p>
			</section>

			<section class="taste-section" id="results-section">
				<div id="results"></div>
			</section>
		</main>

		<script type="module">
			import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
			import { SUPABASE_URL, SUPABASE_ANON_KEY } from "./supabase-config.js";

			const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
			const {
				data: { session },
			} = await supabase.auth.getSession();
			if (!session) {
				window.location.href = "index.html";
			}

			// Simple toggle for pills and meal chips (visual only)
			document.querySelectorAll(".meal-chip").forEach((btn) => {
				btn.addEventListener("click", () => {
					document
						.querySelectorAll(".meal-chip")
						.forEach((b) => b.classList.remove("meal-chip-active"));
					btn.classList.add("meal-chip-active");
				});
			});

			document.querySelectorAll(".pill, .pill-icon").forEach((btn) => {
				btn.addEventListener("click", () => {
					btn.classList.toggle("pill-on");
				});
			});

			// Slide-out menu toggle
			const backdrop = document.getElementById("menu-backdrop-chutomer");
			const toggle = document.querySelector(".app-menu-toggle");
			const closeMenu = () => backdrop.classList.remove("is-open");
			toggle.addEventListener("click", () => {
				backdrop.classList.toggle("is-open");
			});
			backdrop.addEventListener("click", (e) => {
				if (e.target === backdrop) closeMenu();
			});

			// NaÄtenÃ­ a zobrazenÃ­ receptÅ¯ aktuÃ¡lnÃ­ho uÅ¾ivatele
			const resultsContainer = document.getElementById("results");
			const searchButton = document.querySelector(".btn-primary-wide");
			const surpriseButton = document.querySelector(".btn-secondary");

			const timeLabels = ["<15 min", "15â€“30 min", "30â€“60 min", ">1 h"];
			let allRecipes = [];

			function renderRecipes(recipes) {
				resultsContainer.innerHTML = "";

				if (!recipes || recipes.length === 0) {
					const empty = document.createElement("p");
					empty.className = "taste-label";
					empty.textContent = "ZatÃ­m tu nejsou Å¾Ã¡dnÃ© recepty. PÅ™idej novÃ½ v ReceptÃ¡Å™i.";
					resultsContainer.appendChild(empty);
					return;
				}

					recipes.forEach((recipe) => {
						const article = document.createElement("article");
						article.className = "recipe-card";

						let imageEl;
						if (recipe.photo_url) {
							imageEl = document.createElement("img");
							imageEl.className = "recipe-card-photo";
							imageEl.src = recipe.photo_url;
							imageEl.alt = recipe.name || "Foto receptu";
						} else {
							imageEl = document.createElement("div");
							imageEl.className = "recipe-image-placeholder";
							imageEl.setAttribute("aria-hidden", "true");
						}

					const info = document.createElement("div");
					info.className = "recipe-info";

					const title = document.createElement("h2");
					title.className = "recipe-title";
					title.textContent = recipe.name || "Bez nÃ¡zvu";

					const metaRow = document.createElement("div");
					metaRow.className = "recipe-meta-row";

					if (recipe.meal_type) {
						const span = document.createElement("span");
						span.className = "recipe-tag";
						span.textContent = recipe.meal_type;
						metaRow.appendChild(span);
					}

					if (recipe.prep_time_bucket !== null && recipe.prep_time_bucket !== undefined) {
						const span = document.createElement("span");
						span.className = "recipe-tag";
						const idx = Number(recipe.prep_time_bucket);
						span.textContent = timeLabels[idx] ?? "";
						metaRow.appendChild(span);
					}

					if (Array.isArray(recipe.vibes) && recipe.vibes.length > 0) {
						const span = document.createElement("span");
						span.className = "recipe-tag";
						span.textContent = recipe.vibes[0];
						metaRow.appendChild(span);
					}

						info.appendChild(title);
						info.appendChild(metaRow);

						article.appendChild(imageEl);
					article.appendChild(info);

						// KliknutÃ­ na kartu otevÅ™e detail receptu
						if (recipe.id) {
							article.addEventListener("click", () => {
								window.location.href = `recept.html?id=${encodeURIComponent(
									recipe.id
								)}`;
							});
						}

					resultsContainer.appendChild(article);
				});
			}

			async function fetchRecipes() {
				try {
					const { data, error } = await supabase
						.from("recipes")
						.select("*")
						.order("created_at", { ascending: false });

					if (error) {
						console.error("Chyba pÅ™i naÄÃ­tÃ¡nÃ­ receptÅ¯", error);
						alert("NepodaÅ™ilo se naÄÃ­st recepty.");
						return [];
					}

					const withUrls = await Promise.all(
						(data ?? []).map(async (recipe) => {
							if (recipe.photo_path) {
								try {
									const { data: signed, error: signedError } =
										await supabase.storage
											.from("recipe-photos")
											.createSignedUrl(recipe.photo_path, 60 * 60);
									if (!signedError && signed?.signedUrl) {
										recipe.photo_url = signed.signedUrl;
									}
								} catch (e) {
									console.warn("NepodaÅ™ilo se vytvoÅ™it URL fotky", e);
								}
							}
							return recipe;
						})
					);

					allRecipes = withUrls;
					return allRecipes;
				} catch (err) {
					console.error("NeoÄekÃ¡vanÃ¡ chyba pÅ™i naÄÃ­tÃ¡nÃ­ receptÅ¯", err);
					alert("DoÅ¡lo k neoÄekÃ¡vanÃ© chybÄ› pÅ™i naÄÃ­tÃ¡nÃ­ receptÅ¯.");
					return [];
				}
			}

			async function loadAllRecipes() {
				const recipes = await fetchRecipes();
				renderRecipes(recipes);
			}

			function getFilteredRecipes(source) {
				if (!source || !source.length) return [];

				// Typ jÃ­dla
				const activeMealEl = document.querySelector(
					".meal-chip.meal-chip-active .meal-label-main"
				);
				const activeMeal = activeMealEl
					? activeMealEl.textContent.trim().toUpperCase()
					: null;

				// ÄŒas
				const timeSlider = document.querySelector(".time-slider");
				const selectedBucket = timeSlider ? Number(timeSlider.value) : null;

				// OmezenÃ­
				const selectedDietary = Array.from(
					document.querySelectorAll(".pill.pill-on")
				).map((el) => el.textContent.trim().toUpperCase());

				// Vibe
				const selectedVibes = Array.from(
					document.querySelectorAll(".pill-icon.pill-on")
				).map((el) => el.textContent.trim().toLowerCase());

				// Ingredience (fulltext)
				const ingredientInput = document.getElementById("ingredient");
				const ingredientQuery = ingredientInput
					? ingredientInput.value.trim().toLowerCase()
					: "";

				return source.filter((recipe) => {
					// Typ jÃ­dla
					if (activeMeal && recipe.meal_type) {
						if (recipe.meal_type.trim().toUpperCase() !== activeMeal) {
							return false;
						}
					}

					// ÄŒas
					if (
						selectedBucket !== null &&
						selectedBucket !== undefined &&
						recipe.prep_time_bucket !== null &&
						recipe.prep_time_bucket !== undefined
					) {
						if (Number(recipe.prep_time_bucket) !== selectedBucket) {
							return false;
						}
					}

					// OmezenÃ­
					if (selectedDietary.length) {
						const dietary = Array.isArray(recipe.dietary)
							? recipe.dietary.map((d) => String(d).trim().toUpperCase())
							: [];
						const allMatch = selectedDietary.every((tag) =>
							dietary.includes(tag)
						);
						if (!allMatch) return false;
					}

					// Vibe
					if (selectedVibes.length) {
						const vibes = Array.isArray(recipe.vibes)
							? recipe.vibes.map((v) => String(v).trim().toLowerCase())
							: [];
						const allMatch = selectedVibes.every((tag) =>
							vibes.includes(tag)
						);
						if (!allMatch) return false;
					}

					// Ingredience fulltext
					if (ingredientQuery) {
						const ingredients = Array.isArray(recipe.ingredients)
							? recipe.ingredients
							: [];
						const hasMatch = ingredients.some((ing) =>
							String(ing).toLowerCase().includes(ingredientQuery)
						);
						if (!hasMatch) return false;
					}

					return true;
				});
			}

			// Hledat â€“ pouÅ¾ije vÅ¡echny zvolenÃ© filtry
			if (searchButton) {
				searchButton.addEventListener("click", async () => {
					if (!allRecipes.length) {
						await loadAllRecipes();
					}
					const filtered = getFilteredRecipes(allRecipes);
					renderRecipes(filtered);
				});
			}

			// PÅ™ekvap mÄ› â€“ nÃ¡hodnÃ½ recept z filtrovanÃ©ho seznamu
			if (surpriseButton) {
				surpriseButton.addEventListener("click", async () => {
					if (!allRecipes.length) {
						await loadAllRecipes();
					}
					const filtered = getFilteredRecipes(allRecipes);
					if (!filtered.length) {
						renderRecipes([]);
						return;
					}
					const random =
						filtered[Math.floor(Math.random() * filtered.length)];
					renderRecipes([random]);
				});
			}

			// NaÄteme vÅ¡echny recepty hned po naÄtenÃ­ strÃ¡nky
			loadAllRecipes();
		</script>
	</body>
</html>
